from typing import Optional
from datetime import datetime, timezone

from fastapi import FastAPI, Depends, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from sqlalchemy.orm import Session

from database import get_db
from models import Product, CPU, GPU, Motherboard, PCCase, PSU, RAM, Storage, Cooler
from schemas import ProductOut, ProductListResponse

# ⬇️ tady importujeme tvůj scraper jako modul
import update_all_prices as up


app = FastAPI(title="PC Configurator API")

# CORS pro frontend
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://127.0.0.1:5500",
        "http://localhost:5500",
        "http://127.0.0.1:5173",
        "http://localhost:5173",
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Obrázky (backend/img)
app.mount("/img", StaticFiles(directory="img"), name="img")


@app.get("/health")
def health():
    return {"ok": True}


# ======================
#   PRODUCTS – SEZNAM
# ======================

@app.get("/products", response_model=ProductListResponse)
def list_products(
    category: Optional[str] = None,
    limit: int = 15,
    offset: int = 0,
    db: Session = Depends(get_db),
):
    if limit < 1:
        limit = 1
    if limit > 200:
        limit = 200
    if offset < 0:
        offset = 0

    query = db.query(Product)

    if category:
        query = query.filter(Product.category == category)

    total = query.count()

    items = (
        query
        .order_by(Product.id)
        .offset(offset)
        .limit(limit)
        .all()
    )

    return {
        "items": items,
        "total": total,
        "limit": limit,
        "offset": offset,
    }


# ======================
#   PRODUCTS – DETAIL
# ======================

@app.get("/products/{product_id}", response_model=ProductOut)
def get_product_detail(
    product_id: int,
    db: Session = Depends(get_db),
):
    product = db.query(Product).filter(Product.id == product_id).first()
    if not product:
        raise HTTPException(status_code=404, detail="Produkt nenalezen")

    product.spec = get_spec_for_product(product, db)

    return product


# ======================
#   HELPER: REFRESH CENY
# ======================

def compute_new_price_for_product(product: Product) -> Optional[int]:
    """
    Vrátí novou cenu v Kč (int) nebo:
      - 1 = produkt skončil
      - None = nepodařilo se zjistit (necháme starou cenu)
    """
