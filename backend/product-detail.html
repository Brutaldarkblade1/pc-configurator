<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Detail produktu</title>
    <style>
        :root {
            --bg: #eef1f7;
            --page-bg: linear-gradient(180deg, #f7f9ff 0%, #eef1f7 100%);
            --card: #ffffff;
            --muted: #e5e9f1;
            --border: #dfe3ea;
            --text: #0e1424;
            --muted-text: #606778;
            --primary: #2563eb;
            --primary-dark: #1f4fbf;
            --danger: #ef4444;
            --shadow: 0 22px 60px rgba(15, 23, 42, 0.06);
            --shadow-soft: 0 12px 28px rgba(15, 23, 42, 0.05);
            --radius: 14px;
        }

        .dark {
            --bg: #0e1219;
            --page-bg: radial-gradient(circle at 20% 18%, rgba(46, 58, 89, 0.35) 0, transparent 32%),
                        linear-gradient(180deg, #0d1117 0%, #0b1016 100%);
            --card: #111827;
            --muted: #1a2231;
            --border: #1f2a3a;
            --text: #e5e7eb;
            --muted-text: #9ca3af;
            --primary: #3b82f6;
            --primary-dark: #2f6fde;
            --danger: #f87171;
            --shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
            --shadow-soft: 0 12px 26px rgba(0, 0, 0, 0.35);
        }

        * { box-sizing: border-box; }

        body {
            font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
            max-width: 1280px;
            margin: 0 auto;
            padding: 32px 24px 48px;
            background: var(--page-bg);
            color: var(--text);
        }

        a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .top-link {
            position: fixed;
            top: 16px;
            left: 18px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 9px 14px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 999px;
            box-shadow: var(--shadow);
            color: var(--text);
            font-weight: 600;
            font-size: 14px;
            transition: transform 0.12s ease, box-shadow 0.12s ease;
            z-index: 60;
        }

        .top-link:hover {
            transform: translateY(-1px);
            box-shadow: 0 18px 40px rgba(37, 99, 235, 0.18);
        }

        .page-header {
            margin: 16px 0 14px 0;
            padding-left: 58px;
        }

        .eyebrow {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--muted);
            color: var(--primary);
            border-radius: 999px;
            font-weight: 700;
            font-size: 12px;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        h1 {
            margin: 10px 0 6px 0;
            font-size: 28px;
            letter-spacing: -0.02em;
        }

        .lead {
            margin: 6px 0 0 0;
            color: var(--muted-text);
            max-width: 760px;
            line-height: 1.6;
            font-size: 15px;
        }

        /* === THEME TOGGLE (stejné jako Produkty) === */
        .theme-toggle {
            position: fixed;
            top: 16px;
            right: 18px;
            z-index: 60;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle button {
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            border-radius: 12px;
            width: 38px;
            height: 38px;
            padding: 0;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--shadow-soft);
            transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .theme-toggle button:hover {
            transform: translateY(-1px);
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .theme-icon { width: 18px; height: 18px; display: block; }

        .theme-tooltip {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--card);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: var(--shadow-soft);
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-4px);
            pointer-events: none;
            transition: opacity 0.15s ease, transform 0.15s ease;
        }

        .theme-toggle:hover .theme-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        /* === /THEME TOGGLE === */

        /* Kontrast ve formátech detailu */
        .lead { color: var(--muted-text); }

        #product-info,
        #build-sidebar,
        .description,
        .meta { color: var(--text); }

        #product-container,
        #build-sidebar {
            background: var(--card);
            border-color: var(--border);
        }

        #spec-table th,
        #spec-table td { color: var(--text); }

        #spec-table tbody td:first-child { color: var(--muted-text); }

        #error {
            color: var(--danger);
            margin: 12px 0;
            padding: 10px 12px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.35);
            border-radius: 12px;
            display: none;
        }

        #error:not(:empty) { display: block; }

        .layout {
            display: grid;
            grid-template-columns: 1.6fr 0.9fr;
            gap: 22px;
            align-items: flex-start;
            padding-left: 58px;
        }

        main { flex: 1 1 auto; }
        aside { width: 100%; }

        #product-container {
            background: var(--card);
            border-radius: var(--radius);
            padding: 18px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border);
            margin-top: 8px;
            display: grid;
            grid-template-columns: minmax(260px, 1fr) 1.15fr;
            gap: 20px;
            align-items: flex-start;
        }

        #img-holder {
            background: var(--muted);
            border: 1px solid var(--border);
            border-radius: 14px;
            min-height: 320px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            position: relative;
        }

        #product-image {
            max-width: 100%;
            max-height: 360px;
            object-fit: contain;
        }

        #product-info h1 {
            margin: 0 0 8px 0;
            font-size: 24px;
            letter-spacing: -0.01em;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--muted);
            border-radius: 999px;
            color: var(--muted-text);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .price {
            color: var(--primary);
            font-size: 22px;
            font-weight: 800;
            margin: 8px 0 6px 0;
        }

        .price.unavailable { color: var(--danger); }

        .status {
            color: var(--danger);
            font-weight: 700;
            margin-bottom: 6px;
        }

        .meta {
            font-size: 14px;
            color: var(--muted-text);
            margin-bottom: 4px;
        }

        .description {
            margin-top: 14px;
            font-size: 14px;
            line-height: 1.55;
            color: var(--text);
        }

        #add-to-build {
            margin: 6px 0 12px 0;
            padding: 12px 16px;
            font-size: 14px;
            border-radius: 12px;
            border: none;
            background: var(--primary);
            color: #fff;
            cursor: pointer;
            font-weight: 700;
            width: 100%;
            transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
        }

        #add-to-build:hover {
            background: var(--primary-dark);
            box-shadow: 0 18px 40px rgba(37, 99, 235, 0.25);
            transform: translateY(-1px);
        }

        /* Sidebar – sestava */
        #build-sidebar {
            background: var(--card);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border);
            position: sticky;
            top: 84px;
        }

        #build-sidebar h2 {
            font-size: 17px;
            margin: 0 0 10px 0;
            text-align: center;
            letter-spacing: -0.01em;
        }

        #build-list {
            list-style: none;
            padding-left: 0;
            margin: 0;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #build-list li {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            background: var(--muted);
        }

        #build-empty {
            font-size: 13px;
            color: var(--muted-text);
            text-align: center;
            padding: 14px 8px;
            background: var(--muted);
            border: 1px dashed var(--border);
            border-radius: 12px;
        }

        .build-remove-btn {
            border: none;
            background: #ffe4e6;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            color: var(--danger);
            border-radius: 8px;
            width: 26px;
            height: 26px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s ease, transform 0.1s ease;
        }

        .build-remove-btn:hover {
            font-weight: bold;
            transform: translateY(-1px);
        }

        #build-total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            display: none;
            justify-content: space-between;
            font-weight: 700;
            font-size: 13px;
        }

        #build-total span:last-child {
            white-space: nowrap;
            color: var(--primary);
        }

        #build-open {
            display: none;
            margin-top: 12px;
            padding: 10px 12px;
            border-radius: 12px;
            background: var(--primary);
            color: #fff;
            text-decoration: none;
            font-size: 13px;
            text-align: center;
            font-weight: 700;
            transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease;
            width: 100%;
            display: inline-block;
        }

        #build-open:hover {
            background: var(--primary-dark);
            box-shadow: 0 18px 40px rgba(37, 99, 235, 0.25);
            transform: translateY(-1px);
        }

        /* Specifikace – tabulka */
        #spec-table {
            margin-top: 16px;
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid var(--border);
            font-size: 14px;
            box-shadow: var(--shadow-soft);
            background: var(--card);
        }

        #spec-table table {
            width: 100%;
            border-collapse: collapse;
        }

        #spec-table thead { background: var(--muted); }

        #spec-table th,
        #spec-table td { padding: 10px 12px; }

        #spec-table th {
            text-align: left;
            font-weight: 700;
            color: var(--text);
        }

        #spec-table thead th { border-bottom: 1px solid var(--border); }

        #spec-table tbody tr:nth-child(odd),
        #spec-table tbody tr:nth-child(even) {
            background: var(--card);
        }

        #spec-table tbody td:first-child {
            width: 38%;
            color: var(--muted-text);
            font-weight: 600;
        }

        #spec-table caption {
            caption-side: top;
            text-align: left;
            padding: 10px 12px;
            font-weight: 700;
            background: var(--muted);
            border-bottom: 1px solid var(--border);
        }

        /* Loader pro cenu */
        .price-loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--muted-text);
        }

        .product-link-btn {
            margin-top: 10px;
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--primary);
            background: transparent;
            color: var(--primary);
            font-weight: 700;
            cursor: pointer;
            transition: background 0.15s ease, color 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease;
        }

        .product-link-btn:hover {
            background: var(--primary);
            color: #fff;
            box-shadow: var(--shadow);
            transform: translateY(-1px);
        }

        .spinner {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #ccc;
            border-top-color: var(--primary);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to   { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .layout { grid-template-columns: 1fr; }
            #build-sidebar { position: relative; top: 0; }
        }

        @media (max-width: 768px) {
            body { padding: 22px 16px 36px; }
            #product-container { grid-template-columns: 1fr; }
            .page-header,
            .layout { padding-left: 0; }
        }
    </style>
</head>
<body>

<!-- THEME TOGGLE (ikonka + tooltip) -->
<div class="theme-toggle">
    <button id="themeToggle" type="button" aria-label="Tmavý režim" title="Tmavý režim">
        <svg class="theme-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" focusable="false">
            <path d="M21 14.5A8 8 0 1 1 11.5 4a6 6 0 1 0 9.5 10.5z"/>
        </svg>
    </button>
    <span class="theme-tooltip" id="themeTooltip">Přepnout na tmavý režim</span>
</div>

<a class="top-link" href="products.html">← Jít zpět</a>

<div class="page-header">
    <span class="eyebrow">Detail produktu</span>
    <h1>Parametry a dostupnost</h1>
    <p class="lead">Prohlédněte si podrobnosti, cenu a přidejte produkt rovnou do sestavy.</p>
</div>

<div class="layout">
    <main>
        <div id="error"></div>

        <div id="product-container" style="display: none;">
            <div id="img-holder"></div>
            <div id="product-info">
                <h1 id="product-name">Načítám...</h1>

                <div id="product-status" class="status"></div>
                <div id="product-price" class="price"></div>

                <button id="add-to-build">Přidat do sestavy</button>

                <div id="product-description" class="description"></div>
                <button id="product-link" class="product-link-btn" style="display:none;"></button>

                <div id="spec-table"></div>
            </div>
        </div>
    </main>

    <aside id="build-sidebar">
        <h2>Vaše sestava</h2>
        <p id="build-empty">Zatím není nic vybráno.</p>
        <ul id="build-list"></ul>

        <div id="build-total">
            <span>Celková cena:</span>
            <span id="build-total-value">0 Kč</span>
        </div>

        <a id="build-open" href="build.html">Otevřít sestavu</a>
    </aside>
</div>

<script>
    /* ====== THEME (stejné jako Produkty) ====== */
    const THEME_KEY = "pc_theme_mode_v1";

    function applyTheme(mode) {
        const next = mode === "dark" ? "dark" : "light";
        document.body.classList.toggle("dark", next === "dark");
        try { localStorage.setItem(THEME_KEY, next); } catch {}

        const btn = document.getElementById("themeToggle");
        if (btn) {
            const isDark = next === "dark";
            btn.title = isDark ? "Světlý režim" : "Tmavý režim";
            btn.setAttribute("aria-label", btn.title);

            // ikony (stejné jako Produkty)
            btn.innerHTML = `<svg class="theme-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" focusable="false"><path d="M12 4.5a1 1 0 0 1 1 1V7a1 1 0 1 1-2 0V5.5a1 1 0 0 1 1-1zm0 11a3.5 3.5 0 1 1 0-7 3.5 3.5 0 0 1 0 7zm7.5-3.5a1 1 0 0 1 1 1v0a1 1 0 1 1-2 0 1 1 0 0 1 1-1zM4.5 12a1 1 0 0 1 1-1h0a1 1 0 1 1 0 2 1 1 0 0 1-1-1zm12.02-6.02a1 1 0 0 1 1.41 0l.49.49a1 1 0 0 1-1.41 1.41l-.49-.49a1 1 0 0 1 0-1.41zM5.58 17.42a1 1 0 0 1 1.41 0l.49.49a1 1 0 1 1-1.41 1.41l-.49-.49a1 1 0 0 1 0-1.41zm12.35 1.41a1 1 0 0 1-1.41 0l-.49-.49a1 1 0 0 1 1.41-1.41l.49.49a1 1 0 0 1 0 1.41zM7.48 5.98a1 1 0 0 1-1.41 0l-.49-.49A1 1 0 0 1 7 4.08l.49.49a1 1 0 0 1 0 1.41z"/></svg>`;
            if (!isDark) {
                btn.innerHTML = `<svg class="theme-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" focusable="false"><path d="M21 14.5A8 8 0 1 1 11.5 4a6 6 0 1 0 9.5 10.5z"/></svg>`;
            }

            const tooltip = document.getElementById("themeTooltip");
            if (tooltip) {
                tooltip.textContent = isDark ? "Přepnout na světlý režim" : "Přepnout na tmavý režim";
            }
        }
    }

    (function initTheme() {
        let saved = null;
        try { saved = localStorage.getItem(THEME_KEY); } catch {}
        if (!saved) {
            saved = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
        }
        applyTheme(saved);

        const btn = document.getElementById("themeToggle");
        if (btn) {
            btn.addEventListener("click", () => {
                const next = document.body.classList.contains("dark") ? "light" : "dark";
                applyTheme(next);
            });
        }
    })();
    /* ====== /THEME ====== */

    const API_BASE = (window.location && window.location.port === "8000")
        ? window.location.origin
        : "http://127.0.0.1:8000";
    const BUILD_KEY = "pc_build_v2";

    const CATEGORY_LABELS = {
        cpu: "Procesory",
        mb: "Základní desky",
        motherboard: "Základní deska",
        gpu: "Grafické karty",
        ram: "Operační paměť",
        psu: "Zdroj",
        case: "Skříně",
        ssd: "SSD disky",
        hdd: "HDD disky",
        storage: "Úložiště",
        cooler: "Chlazení",
        monitor: "Monitory"
    };

    const CATEGORY_ORDER = [
        "cpu",
        "motherboard",
        "mb",
        "ram",
        "gpu",
        "storage",
        "psu",
        "case",
        "cooler",
        "monitor"
    ];

    function getCategoryLabel(cat) {
        if (!cat) return "Neznámá kategorie";
        const key = String(cat).toLowerCase();
        if (CATEGORY_LABELS[key]) return CATEGORY_LABELS[key];
        return key.charAt(0).toUpperCase() + key.slice(1);
    }

    function isMultiCategory(catKey) {
        const key = String(catKey || "").toLowerCase();

        // Více kusů – RAM + úložiště
        if (["ssd", "hdd", "storage", "ram"].includes(key)) return true;
        if (key.includes("ssd")) return true;
        if (key.includes("hdd")) return true;
        if (key.includes("disk")) return true;
        if (key.includes("ulož") || key.includes("uloz")) return true;
        if (key.includes("storage")) return true;
        if (key.includes("ram")) return true;
        if (key.includes("paměť") || key.includes("pamet")) return true;

        return false;
    }

    function formatKc(value) {
        if (value == null || isNaN(value)) return "";
        return Number(value).toLocaleString("cs-CZ") + " Kč";
    }

    function getIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get("id");
    }

    // ====== práce se sestavou (localStorage) ======

    function normalizeBuildItems(itemsArr) {
        const normalized = [];
        const indexByKey = new Map();

        (Array.isArray(itemsArr) ? itemsArr : []).forEach((raw) => {
            if (!raw || raw.id == null) return;

            const category = String(raw.category || "other").toLowerCase();
            const qty = Math.max(1, Number(raw.qty) || 1);
            const key = `${category}::${raw.id}`;
            const existingIndex = indexByKey.get(key);

            if (existingIndex !== undefined) {
                const existing = normalized[existingIndex];
                existing.qty += qty;
                if (!existing.name && raw.name) existing.name = raw.name;
                if (existing.price == null && typeof raw.price === "number") existing.price = raw.price;
                if (existing.old_price == null && typeof raw.old_price === "number") existing.old_price = raw.old_price;
                return;
            }

            indexByKey.set(key, normalized.length);
            normalized.push({
                id: raw.id,
                name: raw.name,
                category,
                price: (typeof raw.price === "number" ? raw.price : null),
                old_price: (typeof raw.old_price === "number" ? raw.old_price : null),
                qty
            });
        });

        return normalized;
    }

    function loadBuildItems() {
        try {
            const raw = localStorage.getItem(BUILD_KEY);
            if (!raw) return [];
            const parsed = JSON.parse(raw);

            if (Array.isArray(parsed)) return normalizeBuildItems(parsed);

            if (parsed && typeof parsed === "object") {
                const arr = [];
                for (const [cat, value] of Object.entries(parsed)) {
                    if (Array.isArray(value)) {
                        value.forEach(v => {
                            if (!v) return;
                            arr.push({
                                id: v.id,
                                name: v.name,
                                category: String(v.category || cat).toLowerCase(),
                                price: (typeof v.price === "number" ? v.price : null),
                                old_price: (typeof v.old_price === "number" ? v.old_price : null),
                                qty: Math.max(1, Number(v.qty) || 1)
                            });
                        });
                    } else if (value) {
                        arr.push({
                            id: value.id,
                            name: value.name,
                            category: String(value.category || cat).toLowerCase(),
                            price: (typeof value.price === "number" ? value.price : null),
                            old_price: (typeof value.old_price === "number" ? value.old_price : null),
                            qty: Math.max(1, Number(value.qty) || 1)
                        });
                    }
                }
                return normalizeBuildItems(arr);
            }

            return [];
        } catch (e) {
            console.error("Chyba při čtení sestavy:", e);
            return [];
        }
    }

    function saveBuildItems(itemsArr) {
        localStorage.setItem(BUILD_KEY, JSON.stringify(itemsArr));
    }

    function getBasePrice(item) {
        if (!item) return null;
        if (item.price === 1) {
            if (typeof item.old_price === "number") return item.old_price;
            return null;
        }
        if (typeof item.price === "number") return item.price;
        if (typeof item.old_price === "number") return item.old_price;
        return null;
    }

    function getNumericItemPrice(item) {
        if (!item) return 0;
        const qty = item.qty && item.qty > 0 ? item.qty : 1;
        const base = getBasePrice(item);
        if (base == null) return 0;
        return base * qty;
    }

    function formatItemPriceText(item) {
        if (!item) return "";
        const qty = item.qty && item.qty > 0 ? item.qty : 1;
        const base = getBasePrice(item);

        if (item.price === 1 && base == null) return "nedostupné";
        if (item.price === 1 && base != null) return qty > 1 ? `${qty}× poslední ${formatKc(base)}` : `Poslední ${formatKc(base)}`;

        if (item.price == null && base != null) return qty > 1 ? `${qty}× ${formatKc(base)}` : formatKc(base);
        if (base != null) return qty > 1 ? `${qty}× ${formatKc(base)}` : formatKc(base);

        return "";
    }

    function renderBuildSidebar() {
        const listEl = document.getElementById("build-list");
        const emptyEl = document.getElementById("build-empty");
        const totalBox = document.getElementById("build-total");
        const totalVal = document.getElementById("build-total-value");
        const openLink = document.getElementById("build-open");

        const items = loadBuildItems();
        listEl.innerHTML = "";

        if (items.length === 0) {
            emptyEl.style.display = "block";
            if (totalBox) totalBox.style.display = "none";
            if (openLink) openLink.style.display = "none";
            return;
        }

        emptyEl.style.display = "none";

        const sorted = items.slice().sort((a, b) => {
            const ak = String(a.category || "other").toLowerCase();
            const bk = String(b.category || "other").toLowerCase();
            const ai = CATEGORY_ORDER.indexOf(ak);
            const bi = CATEGORY_ORDER.indexOf(bk);

            if (ai !== -1 && bi !== -1 && ai !== bi) return ai - bi;
            if (ai !== -1 && bi === -1) return -1;
            if (ai === -1 && bi !== -1) return 1;

            const labelA = getCategoryLabel(ak);
            const labelB = getCategoryLabel(bk);
            if (labelA !== labelB) {
                return labelA.localeCompare(labelB, "cs");
            }

            const nameA = (a.name || "").toLowerCase();
            const nameB = (b.name || "").toLowerCase();
            return nameA.localeCompare(nameB, "cs");
        });

        let total = 0;

        sorted.forEach(item => {
            const li = document.createElement("li");

            const textSpan = document.createElement("span");
            const label = getCategoryLabel(item.category);
            const name = item.name || "Neznámý produkt";
            const priceTxt = formatItemPriceText(item);
            textSpan.textContent = label + " – " + name + (priceTxt ? " (" + priceTxt + ")" : "");

            const removeBtn = document.createElement("button");
            removeBtn.className = "build-remove-btn";
            removeBtn.textContent = "×";

            removeBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                const itemsNow = loadBuildItems();
                let removed = false;
                const next = [];
                for (const it of itemsNow) {
                    const same = !removed &&
                        it.id === item.id &&
                        String(it.category || "other").toLowerCase() === String(item.category || "other").toLowerCase();

                    if (!same) {
                        next.push(it);
                        continue;
                    }

                    removed = true;
                    const qty = it.qty && it.qty > 0 ? it.qty : 1;
                    if (qty > 1) {
                        next.push({ ...it, qty: qty - 1 });
                    }
                }
                saveBuildItems(next);
                renderBuildSidebar();
            });

            li.appendChild(textSpan);
            li.appendChild(removeBtn);
            listEl.appendChild(li);

            total += getNumericItemPrice(item);
        });

        if (totalBox && totalVal) {
            totalBox.style.display = "flex";
            totalVal.textContent = total.toLocaleString("cs-CZ") + " Kč";
        }
        if (openLink) {
            openLink.style.display = "block";
        }
    }

    function addProductToBuild(product) {
        const catKey = product.category ? String(product.category).toLowerCase() : "other";
        const items = loadBuildItems();
        const multi = isMultiCategory(catKey);

        const newItem = {
            id: product.id,
            name: product.name,
            category: catKey,
            price: product.price,
            old_price: product.old_price,
            qty: 1
        };

        let updated;

        if (multi) {
            let found = false;
            updated = items.map(it => {
                if (
                    it.id === newItem.id &&
                    String(it.category || "other").toLowerCase() === catKey
                ) {
                    found = true;
                    const currentQty = it.qty && it.qty > 0 ? it.qty : 1;
                    return { ...it, qty: currentQty + 1 };
                }
                return it;
            });
            if (!found) updated.push(newItem);
        } else {
            // Ostatní – vždy max. 1 kus na kategorii
            const existing = items.find(it => String(it.category || "other").toLowerCase() === catKey);
            if (existing && existing.id !== newItem.id) {
                const label = getCategoryLabel(catKey);
                const ok = window.confirm(`V sestavě už máte položku z kategorie ${label}: ${existing.name}.
Chcete ji vyměnit za ${product.name}?`);
                if (!ok) return;
            }

            updated = items.filter(it => {
                const itsCat = String(it.category || "other").toLowerCase();
                return itsCat !== catKey;
            });
            updated.push(newItem);
        }

        saveBuildItems(updated);
        renderBuildSidebar();
    }

    // --- Specifikace z databáze (používáme jen sloupce z jednotlivých tabulek) ---
    function normalizeSpecValue(value, suffix = "") {
        if (value === undefined || value === null) return "";
        let text = String(value).trim();
        if (!text) return "";
        text = text.replace(/^(amd)(am4)$/i, "$1 $2");
        text = text.replace(/^(amd)(am5)$/i, "$1 $2");
        return suffix ? text + suffix : text;
    }

    function buildSpecsFromDb(product) {
        if (!product || !product.spec) return [];

        const spec = product.spec || {};
        const catKey = String(product.category || "").toLowerCase();
        const rows = [];

        const add = (label, value, suffix = "") => {
            const v = normalizeSpecValue(value, suffix);
            if (v) rows.push({ label, value: v });
        };

        if (product.brand) add("Značka", product.brand);

        if (catKey === "cpu") {
            add("Socket", spec.socket);
            add("TDP", spec.tdp, " W");
            if (spec.igpu !== undefined && spec.igpu !== null) {
                add("Integrovaná grafika", spec.igpu ? "Ano" : "Ne");
            }
        } else if (catKey === "ram") {
            add("Typ", spec.type);
            add("Rychlost", spec.speed_mhz, " MHz");
            add("Kapacita", spec.capacity_gb, " GB");
            add("Počet modulů", spec.sticks, " ks");
        } else if (["ssd", "hdd", "storage"].includes(catKey)) {
            add("Typ disku", spec.type);
            add("Kapacita", spec.capacity_gb, " GB");
            add("Rozhraní", spec.interface);
        } else if (catKey === "gpu") {
            add("Paměť", spec.vram_gb, " GB");
            add("TDP", spec.tdp, " W");
            add("Délka karty", spec.length_mm, " mm");
        } else if (["psu", "zdroj"].includes(catKey)) {
            add("Výkon", spec.wattage, " W");
            add("Účinnost", spec.efficiency);
            if (spec.modular !== undefined && spec.modular !== null) {
                add("Modulární kabeláž", spec.modular ? "Ano" : "Ne");
            }
        } else if (["case", "skrine", "pc_case"].includes(catKey)) {
            add("Podpora formátu desky", spec.form_factor_support);
            add("Max. délka GPU", spec.gpu_max_length_mm, " mm");
            add("Max. výška chladiče", spec.cooler_max_height_mm, " mm");
            add("Formát zdroje", spec.psu_form_factor);
        } else if (["cooler", "chlazeni"].includes(catKey)) {
            add("Typ", spec.type);
            add("Podpora TDP", spec.tdp_support, " W");
            add("Podporované sockety", spec.socket_support);
            add("Výška", spec.height_mm, " mm");
        } else if (["motherboard", "mb", "deska"].includes(catKey)) {
            add("Socket", spec.socket);
            add("Typ paměti", spec.ram_type);
            add("Formát desky", spec.form_factor);
        }

        return rows;
    }

    function renderSpecsTable(product) {
        const holder = document.getElementById("spec-table");
        holder.innerHTML = "";

        const specs = buildSpecsFromDb(product);
        if (!specs || specs.length === 0) {
            holder.textContent = "Specifikace nejsou v databázi k dispozici.";
            return;
        }

        const table = document.createElement("table");
        const caption = document.createElement("caption");
        caption.textContent = "Specifikace";
        table.appendChild(caption);

        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");
        const th1 = document.createElement("th");
        th1.textContent = "Parametr";
        const th2 = document.createElement("th");
        th2.textContent = "Hodnota";
        headRow.appendChild(th1);
        headRow.appendChild(th2);
        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        specs.forEach(row => {
            const tr = document.createElement("tr");
            const td1 = document.createElement("td");
            const td2 = document.createElement("td");
            td1.textContent = row.label;
            td2.textContent = row.value;
            tr.appendChild(td1);
            tr.appendChild(td2);
            tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        holder.appendChild(table);
    }

    function updatePriceBlock(product) {
        const statusEl = document.getElementById("product-status");
        const priceEl = document.getElementById("product-price");

        let priceText = "";

        if (product.price === 1) {
            statusEl.textContent = "Produkt již není dostupný";
            priceEl.classList.add("unavailable");

            if (product.old_price != null) {
                priceText = "Poslední známá cena: " + formatKc(product.old_price);
            } else {
                priceText = "";
            }
        } else {
            statusEl.textContent = "";
            priceEl.classList.remove("unavailable");

            if (product.price == null) {
                priceText = "Cena na dotaz";
            } else {
                priceText = formatKc(product.price);
            }
        }

        priceEl.textContent = priceText;
    }

    async function refreshPrice(product) {
        const priceEl = document.getElementById("product-price");
        const statusEl = document.getElementById("product-status");
        const errorDiv = document.getElementById("error");

        errorDiv.textContent = "";
        statusEl.textContent = "";
        priceEl.classList.remove("unavailable");

        priceEl.innerHTML = `
            <span class="price-loading">
                <span class="spinner"></span>
                Načítá se cena produktu...
            </span>
        `;

        try {
            const res = await fetch(`${API_BASE}/products/${product.id}/refresh-price`, {
                method: "POST"
            });

            if (!res.ok) {
                console.warn("Chyba při ověření ceny:", res.status, res.statusText);
                updatePriceBlock(product);
                return;
            }

            const updated = await res.json();
            Object.assign(product, updated);
            updatePriceBlock(product);

        } catch (e) {
            console.error("Výjimka při ověření ceny:", e);
            updatePriceBlock(product);
        }
    }

    async function loadProduct() {
        const id = getIdFromUrl();
        const errorDiv = document.getElementById("error");
        const container = document.getElementById("product-container");
        const imgHolder = document.getElementById("img-holder");

        errorDiv.textContent = "";

        if (!id) {
            errorDiv.textContent = "Chybí ID produktu v URL.";
            return;
        }

        try {
            const res = await fetch(API_BASE + "/products/" + id);
            if (!res.ok) {
                throw new Error("Chyba API: " + res.status + " " + res.statusText);
            }

            const product = await res.json();

            container.style.display = "grid";

            imgHolder.innerHTML = "";
            const img = document.createElement("img");
            img.id = "product-image";

            let triedPng = false;
            let triedJpeg = false;
            img.src = API_BASE + "/img/" + product.id + ".jpg";

            img.onerror = function () {
                if (!triedPng) {
                    triedPng = true;
                    this.src = API_BASE + "/img/" + product.id + ".png";
                    return;
                }
                if (!triedJpeg) {
                    triedJpeg = true;
                    this.src = API_BASE + "/img/" + product.id + ".jpeg";
                    return;
                }

                this.remove();
                const fallback = document.createElement("div");
                fallback.textContent = "Obrázek není k dispozici";
                fallback.style.padding = "40px 0";
                fallback.style.textAlign = "center";
                fallback.style.color = "#444";
                imgHolder.appendChild(fallback);
            };

            imgHolder.appendChild(img);

            document.getElementById("product-name").textContent =
                product.name || "Neznámý produkt";

            const descEl = document.getElementById("product-description");
            descEl.textContent = product.description || "";

            const linkEl = document.getElementById("product-link");
            if (product.url) {
                linkEl.style.display = "inline-flex";
                linkEl.textContent = "Otevřít stránku produktu";
                linkEl.onclick = () => window.open(product.url, "_blank");
            } else {
                linkEl.style.display = "none";
            }

            renderSpecsTable(product);

            const addBtn = document.getElementById("add-to-build");
            addBtn.onclick = () => addProductToBuild(product);

            updatePriceBlock(product);
            refreshPrice(product);

        } catch (err) {
            console.error(err);
            errorDiv.textContent =
                "Chyba při načítání detailu produktu. Zkontrolujte, jestli běží backend.";
        }
    }

    renderBuildSidebar();
    loadProduct();
</script>
</body>
</html>
