<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Detail produktu</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        a {
            color: #007bff;
            text-decoration: none;
        }

        #error {
            color: red;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        /* Layout hlavní + sidebar */
        .layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        main {
            flex: 1 1 auto;
        }

        aside {
            flex: 0 0 260px;
        }

        #product-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 10px;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            align-items: flex-start;
        }

        #product-image {
            max-width: 100%;
            max-height: 350px;
            object-fit: contain;
            background: #fafafa;
            border-radius: 8px;
            padding: 10px;
        }

        #product-info h1 {
            margin-top: 0;
            margin-bottom: 10px;
        }

        .price {
            color: #007b00;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .price.unavailable {
            color: #b00020;
        }

        .status {
            color: #b00020;
            font-weight: bold;
            margin-bottom: 6px;
        }

        .meta {
            font-size: 14px;
            color: #555;
            margin-bottom: 4px;
        }

        .description {
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.4;
        }

        #add-to-build {
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 20px;
            border: none;
            background: #28a745;
            color: white;
            cursor: pointer;
        }

        #add-to-build:hover {
            background: #218838;
        }

        /* Sidebar – sestava */
        #build-sidebar {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #build-sidebar h2 {
            font-size: 16px;
            margin-top: 0;
            margin-bottom: 10px;
            text-align: center;
        }

        #build-list {
            list-style: none;
            padding-left: 0;
            margin: 0;
            font-size: 13px;
        }

        #build-list li {
            padding: 6px 4px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 6px;
        }

        #build-empty {
            font-size: 13px;
            color: #777;
            text-align: center;
        }

        .build-remove-btn {
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            color: #b00020;
        }

        .build-remove-btn:hover {
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .layout {
                flex-direction: column;
            }

            aside {
                flex: 1 1 auto;
                width: 100%;
                order: 2;
            }

            #product-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<a href="products.html">← Zpět na produkty</a>

<div class="layout">
    <main>
        <div id="error"></div>

        <div id="product-container" style="display: none;">
            <div id="img-holder"></div>
            <div id="product-info">
                <h1 id="product-name">Načítám...</h1>

                <button id="add-to-build">Přidat do sestavy</button>

                <div id="product-status" class="status"></div>
                <div id="product-price" class="price"></div>
                <div id="product-category" class="meta"></div>
                <div id="product-brand" class="meta"></div>
                <div id="product-source" class="meta"></div>
                <div id="product-link" class="meta"></div>
                <div id="product-description" class="description"></div>
            </div>
        </div>
    </main>

    <aside id="build-sidebar">
        <h2>Tvoje sestava</h2>
        <p id="build-empty">Zatím nic vybráno.</p>
        <ul id="build-list"></ul>
    </aside>
</div>

<script>
    const API_BASE = "http://127.0.0.1:8000";
    const BUILD_KEY = "pc_build_v2";

    const CATEGORY_LABELS = {
        cpu: "Procesory",
        mb: "Základní desky",
        gpu: "Grafické karty",
        ram: "Operační paměť",
        psu: "Zdroj",
        case: "Skříně",
        ssd: "SSD disky",
        hdd: "HDD disky",
        storage: "Úložiště",
        cooler: "Chlazení",
        monitor: "Monitory"
    };

    const CATEGORY_ORDER = [
        "cpu",
        "mb",
        "ram",
        "gpu",
        "ssd",
        "hdd",
        "storage",
        "psu",
        "case",
        "cooler",
        "monitor"
    ];

    function getCategoryLabel(cat) {
        if (!cat) return "Neznámá kategorie";
        const key = String(cat).toLowerCase();
        if (CATEGORY_LABELS[key]) return CATEGORY_LABELS[key];
        return key.charAt(0).toUpperCase() + key.slice(1);
    }

    function sortCategories(cats) {
        return cats.slice().sort((a, b) => {
            const ak = String(a).toLowerCase();
            const bk = String(b).toLowerCase();
            const ai = CATEGORY_ORDER.indexOf(ak);
            const bi = CATEGORY_ORDER.indexOf(bk);

            if (ai !== -1 && bi !== -1) return ai - bi;
            if (ai !== -1) return -1;
            if (bi !== -1) return 1;

            return getCategoryLabel(ak).localeCompare(getCategoryLabel(bk), "cs");
        });
    }

    // stejná logika jako v products.html – kde může být víc kusů
    function isMultiCategory(catKey) {
        const key = String(catKey || "").toLowerCase();

        if (["ssd", "hdd", "storage", "ram"].includes(key)) return true;
        if (key.includes("ssd")) return true;
        if (key.includes("hdd")) return true;
        if (key.includes("disk")) return true;
        if (key.includes("ulož") || key.includes("uloz")) return true;
        if (key.includes("storage")) return true;
        if (key.includes("ram")) return true;
        if (key.includes("paměť") || key.includes("pamet")) return true;

        return false;
    }

    function getIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get("id");
    }

    // NOVÝ formát: pole položek (stejně jako v products.html)
    function loadBuildItems() {
        try {
            const raw = localStorage.getItem(BUILD_KEY);
            if (!raw) return [];
            const parsed = JSON.parse(raw);

            // už je to pole
            if (Array.isArray(parsed)) {
                return parsed;
            }

            // starý formát: objekt { cat: item | [items] } → převod na pole
            if (parsed && typeof parsed === "object") {
                const arr = [];
                for (const [cat, value] of Object.entries(parsed)) {
                    if (Array.isArray(value)) {
                        value.forEach(v => {
                            if (!v) return;
                            arr.push({
                                id: v.id,
                                name: v.name,
                                category: v.category || cat
                            });
                        });
                    } else if (value) {
                        arr.push({
                            id: value.id,
                            name: value.name,
                            category: value.category || cat
                        });
                    }
                }
                return arr;
            }

            return [];
        } catch (e) {
            console.error("Chyba při čtení sestavy:", e);
            return [];
        }
    }

    function saveBuildItems(itemsArr) {
        localStorage.setItem(BUILD_KEY, JSON.stringify(itemsArr));
    }

    function renderBuildSidebar() {
        const listEl = document.getElementById("build-list");
        const emptyEl = document.getElementById("build-empty");
        if (!listEl || !emptyEl) return;

        const items = loadBuildItems();
        listEl.innerHTML = "";

        if (items.length === 0) {
            emptyEl.style.display = "block";
            return;
        }

        emptyEl.style.display = "none";

        const sorted = items.slice().sort((a, b) => {
            const ak = String(a.category || "other").toLowerCase();
            const bk = String(b.category || "other").toLowerCase();
            const ai = CATEGORY_ORDER.indexOf(ak);
            const bi = CATEGORY_ORDER.indexOf(bk);

            if (ai !== -1 && bi !== -1 && ai !== bi) return ai - bi;
            if (ai !== -1 && bi === -1) return -1;
            if (ai === -1 && bi !== -1) return 1;

            const labelA = getCategoryLabel(ak);
            const labelB = getCategoryLabel(bk);
            if (labelA !== labelB) {
                return labelA.localeCompare(labelB, "cs");
            }

            const nameA = (a.name || "").toLowerCase();
            const nameB = (b.name || "").toLowerCase();
            return nameA.localeCompare(nameB, "cs");
        });

        sorted.forEach(item => {
            const li = document.createElement("li");

            const textSpan = document.createElement("span");
            const label = getCategoryLabel(item.category);
            const name = item.name || "Neznámý produkt";
            textSpan.textContent = label + " – " + name;

            const removeBtn = document.createElement("button");
            removeBtn.className = "build-remove-btn";
            removeBtn.textContent = "×";

            removeBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                const itemsNow = loadBuildItems();
                const filtered = itemsNow.filter(it => it.id !== item.id);
                saveBuildItems(filtered);
                renderBuildSidebar();
            });

            li.appendChild(textSpan);
            li.appendChild(removeBtn);
            listEl.appendChild(li);
        });
    }

    function addProductToBuild(product) {
        const catKey = product.category ? String(product.category).toLowerCase() : "other";
        const items = loadBuildItems();
        const multi = isMultiCategory(catKey);

        const newItem = {
            id: product.id,
            name: product.name,
            category: catKey
        };

        let updated;

        if (multi) {
            const exists = items.some(it => it.id === newItem.id);
            if (exists) {
                updated = items;
            } else {
                updated = [...items, newItem];
            }
        } else {
            updated = items.filter(it => {
                const itsCat = String(it.category || "other").toLowerCase();
                return itsCat !== catKey;
            });
            updated.push(newItem);
        }

        saveBuildItems(updated);
        renderBuildSidebar();
    }

    async function loadProduct() {
        const id = getIdFromUrl();
        const errorDiv = document.getElementById("error");
        const container = document.getElementById("product-container");
        const imgHolder = document.getElementById("img-holder");

        if (!id) {
            errorDiv.textContent = "Chybí ID produktu v URL.";
            return;
        }

        try {
            const res = await fetch(API_BASE + "/products/" + id);
            if (!res.ok) {
                throw new Error("Chyba API: " + res.status + " " + res.statusText);
            }

            const product = await res.json();

            container.style.display = "grid";

            const img = document.createElement("img");
            img.id = "product-image";

            let triedPng = false;
            let triedJpeg = false;
            img.src = API_BASE + "/img/" + product.id + ".jpg";

            img.onerror = function () {
                if (!triedPng) {
                    triedPng = true;
                    this.src = API_BASE + "/img/" + product.id + ".png";
                    return;
                }
                if (!triedJpeg) {
                    triedJpeg = true;
                    this.src = API_BASE + "/img/" + product.id + ".jpeg";
                    return;
                }

                this.remove();
                const fallback = document.createElement("div");
                fallback.textContent = "Produkt již není dostupný";
                fallback.style.padding = "40px 0";
                fallback.style.textAlign = "center";
                fallback.style.color = "#444";
                imgHolder.appendChild(fallback);
            };

            imgHolder.appendChild(img);

            document.getElementById("product-name").textContent =
                product.name || "Neznámý produkt";

            const statusEl = document.getElementById("product-status");
            const priceEl = document.getElementById("product-price");

            let priceText = "";

            if (product.price === 1) {
                statusEl.textContent = "Produkt již není dostupný";
                priceEl.classList.add("unavailable");

                if (product.old_price != null) {
                    priceText = "Poslední známá cena: " + product.old_price + " Kč";
                } else {
                    priceText = "";
                }
            } else {
                statusEl.textContent = "";
                priceEl.classList.remove("unavailable");

                if (product.price == null) {
                    priceText = "Cena na dotaz";
                } else {
                    priceText = product.price + " Kč";
                }
            }

            priceEl.textContent = priceText;

            const categoryEl = document.getElementById("product-category");
            categoryEl.textContent = product.category
                ? "Kategorie: " + getCategoryLabel(product.category)
                : "";

            const brandEl = document.getElementById("product-brand");
            brandEl.textContent = product.brand ? "Značka: " + product.brand : "";

            const sourceEl = document.getElementById("product-source");
            sourceEl.textContent = product.source ? "Zdroj: " + product.source : "";

            const linkEl = document.getElementById("product-link");
            if (product.url) {
                linkEl.innerHTML =
                    'Otevřít na e-shopu: <a href="' +
                    product.url +
                    '" target="_blank" rel="noopener noreferrer">' +
                    product.url +
                    "</a>";
            } else {
                linkEl.textContent = "";
            }

            const descEl = document.getElementById("product-description");
            descEl.textContent = product.description || "";

            const addBtn = document.getElementById("add-to-build");
            addBtn.addEventListener("click", () => {
                addProductToBuild(product);
            });
        } catch (err) {
            console.error(err);
            errorDiv.textContent =
                "Chyba při načítání detailu produktu. Zkontroluj, jestli běží backend.";
        }
    }

    renderBuildSidebar();
    loadProduct();
</script>
</body>
</html>
